apiVersion: of-catalog/v1alpha1
kind: Component
metadata:
    name: quiz-api
    componentType: service
spec:
    id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:component/4d010f50-96c4-48c0-bab5-a3dd5112b464/b83df64b-5fd9-41d5-ab6d-d0515cd9b32b
    name: quiz-api
    slug: svc-quiz-api
    description: Component quiz-api
    configVersion: 0
    typeId: SERVICE
    ownerId: ari:cloud:identity::team/e072d774-f06a-473d-b478-3967a637fb22
    dependsOn:
        - kubernetes
    fields:
        lifecycle: Active
        tier: 3
    links:
        - id: 19f1a063-8df7-4680-a27c-1c0240496d05
          name: Sponsorship Integration Squad
          type: PROJECT
          url: https://onefootball.atlassian.net/jira/software/projects/SIS/boards/378/backlog
        - id: 7aa96b6d-1e69-4e94-8b02-0b6ebe338859
          name: Prometheus Resource Metrics
          type: DASHBOARD
          url: https://grafana.mgm.onefootball.com/d/pthfJGV4z/kubernetes-app-metrics?orgId=1&refresh=30s&var-DS_PROMETHEUS=P0F161AC36DE6FE17&var-namespace=quiz-api&var-container=quiz-api&from=now-1h&to=now
        - id: e59f7918-6e6f-44f5-9575-6105cc714ad4
          name: Security Vulnerability Report
          type: DASHBOARD
          url: https://grafana.mgm.onefootball.com/d/ycwPj724k/trivy-operator-dashboard?orgId=1&from=now-24h&to=now&timezone=browser&var-DS_PROMETHEUS=P0F161AC36DE6FE17&var-namespace=quiz-api
        - id: ebb013ad-1325-45eb-a7c4-278a2aa49724
          name: OnCall
          type: ON_CALL
          url: https://onefootball.app.opsgenie.com/settings/schedule/detail/191b6b6d-f7eb-4a88-977e-bcc12f38b1b9
        - id: a1c47953-b20a-4f7b-8804-39f0d7a408c3
          name: client-xp
          type: CHAT_CHANNEL
          url: https://onefootball.slack.com/archives/C07MMBZDYV6
        - id: 00ce1a53-a52c-4c04-960f-86c861a6e893
          name: Emissary Metrics
          type: DASHBOARD
          url: https://grafana.mgm.onefootball.com/d/z387xeWVk/ambassador-emissary-ingress?var-window=1m&orgId=1&from=now-30m&to=now&timezone=browser&var-DS_PROMETHEUS=P0F161AC36DE6FE17&var-SERVICE=quiz_api_quiz_api_svc_cluster_local_&refresh=5s
        - id: 1ae509dd-f3d5-4f66-a009-e74f86a4f37c
          name: Repository
          type: REPOSITORY
          url: https://github.com/motain/quiz-api
        - id: 85eb7f6f-097f-4ecb-8224-bb29c0a61f46
          name: Honeycomb
          type: DASHBOARD
          url: https://ui.eu1.honeycomb.io/onefootball/environments/production/datasets/quiz-api/home?tab=traces
    documents:
        - id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:document/4d010f50-96c4-48c0-bab5-a3dd5112b464/acc1771c-a836-4a12-910a-3c19b42b560b
          title: README
          type: Other
          documentationCategoryId: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:documentation-category/4d010f50-96c4-48c0-bab5-a3dd5112b464/154bf547-86c3-4d30-a74e-e73569ae37f8
          url: https://github.com/motain/quiz-api/blob/main/docs/index.md
        - id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:document/4d010f50-96c4-48c0-bab5-a3dd5112b464/907a3ee0-a9b0-45ed-bd15-6717bab99c90
          title: Readme
          type: Other
          documentationCategoryId: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:documentation-category/4d010f50-96c4-48c0-bab5-a3dd5112b464/154bf547-86c3-4d30-a74e-e73569ae37f8
          url: https://github.com/motain/quiz-api/blob/main/docs/index.md
    labels:
        - sponsorship-integration
        - client-experience
    metricSources:
        adaptive-systems:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/e244759b-b8bf-4b55-a6a0-9856ff5a9662
            name: adaptive-systems-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/d6c1a5ed-b0ce-4fed-b020-0a445cc8e6b2
            facts:
                - id: app-toml-replicas-min
                  type: extract
                  source: github
                  jsonPath: .service.replicas_min // .service.production.replicas_min | . >= 3
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: app-toml-replicas-max-gt-replicas-min
                  type: extract
                  source: github
                  jsonPath: (.service.replicas_min // .service.production.replicas_min) < (.service.replicas_max // .service.production.replicas_max)
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: cpu-and-memory-hpa-are-set
                  name: Validate that CPU and Memory Horizontal Pod Autoscalers are set
                  type: aggregate
                  dependsOn:
                    - app-toml-replicas-min
                    - app-toml-replicas-max-gt-replicas-min
                  method: and
        alert-routing-and-notifications:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/eb14d250-c42f-4b94-9af7-e943e6fbe4c3
            name: alert-routing-and-notifications-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/1f42301f-6118-4aef-8a45-80d5b63a0d93
            facts:
                - id: fetch-slos
                  name: Fetch SLOs
                  type: extract
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/slos/quiz-api
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                  rule: jsonpath
                - id: fetch-alerts-for-slos
                  name: Fetch alerts for SLOs
                  type: extract
                  dependsOn:
                    - fetch-slos
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/burn_alerts/quiz-api?slo_id=:slo_id
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                  rule: jsonpath
                - id: fetch-recipients-for-alerts
                  name: Fetch recipients for Alerts
                  type: extract
                  dependsOn:
                    - fetch-alerts-for-slos
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/burn_alerts/quiz-api/:alert_id
                  jsonPath: .recipients[].target
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                  rule: jsonpath
                - id: validate-each-target-is-not-empty-string
                  name: Validate that each target is not an empty string
                  type: validate
                  dependsOn:
                    - fetch-recipients-for-alerts
                  rule: regex_match
                  pattern: ^\S.*$
                - id: validate-all-targets-are-not-empty-strings
                  name: Validate that all targets are not empty strings
                  type: aggregate
                  dependsOn:
                    - validate-each-target-is-not-empty-string
                  method: and
        allocation-efficiency:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/bd944162-e927-4f0b-a592-871c76309457
            name: allocation-efficiency-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/145c429c-b1d4-4f1f-b5c1-f322f62a34ff
            facts:
                - id: check-app-toml-resource-request
                  name: Check if CPU requests and memory requests are defined in app.toml under [service] or [service.production]
                  type: extract
                  source: github
                  jsonPath: (.service.cpu_requests // .service.production.cpu_requests | . != null) and (.service.memory_requests // .service.production.memory_requests | . != null)
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: check-app-toml-cpu-limits
                  name: Check if CPU limits are not defined in app.toml under [service] or [service.production]
                  type: extract
                  source: github
                  jsonPath: .service.cpu_limits // .service.production.cpu_limits | not
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: check-app-toml-memory-limits
                  name: Check if  memory limits are defined in app.toml under [service] or [service.production]
                  type: extract
                  source: github
                  jsonPath: .service.memory_limits // .service.production.memory_limits | . != null
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: aggregate-resource-requests
                  name: check resource requests and limits
                  type: aggregate
                  dependsOn:
                    - check-app-toml-resource-request
                    - check-app-toml-cpu-limits
                    - check-app-toml-memory-limits
                  method: and
        critical-alerts-slo-check:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/29b9efce-c180-4303-8b0a-b86f71d50894
            name: critical-alerts-slo-check-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/65626941-1133-4262-8f52-4e126d409348
            facts:
                - id: fetch-slos
                  name: Fetch SLOs
                  type: extract
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/slos/quiz-api
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                  rule: jsonpath
                - id: fetch-alerts-for-slos
                  name: Fetch alerts for SLOs
                  type: extract
                  dependsOn:
                    - fetch-slos
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/burn_alerts/quiz-api?slo_id=:slo_id
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                  rule: jsonpath
                - id: count-slos
                  name: Count SLOs
                  type: aggregate
                  dependsOn:
                    - fetch-slos
                  method: count
                - id: count-alerts-for-slos
                  name: Count Alerts
                  type: aggregate
                  dependsOn:
                    - fetch-alerts-for-slos
                  method: count
                - id: validate-alerts-for-slos
                  name: Validate that counts match
                  type: validate
                  dependsOn:
                    - count-slos
                    - count-alerts-for-slos
                  rule: deps_match
        deployment-readiness:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/72b6d4a9-a72e-4dfe-8078-8d5ff714bf40
            name: deployment-readiness-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/05fd721b-1464-4973-bee6-ac873c3b75c1
            facts:
                - id: deployment-readiness-replicas-service-production
                  name: Check deployment readiness where min != Max, Min >= 3 and Max > 3
                  type: extract
                  source: github
                  jsonPath: (.service.production.replicas_min != .service.production.replicas_max) and (.service.production.replicas_min >= 3) and (.service.production.replicas_max > 3)
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: deployment-readiness-replicas-service
                  name: Check deployment readiness where min != Max, Min >= 3 and Max > 3
                  type: extract
                  source: github
                  jsonPath: (.service.replicas_min != .service.replicas_max) and (.service.replicas_min >= 3) and (.service.replicas_max > 3)
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: aggregate-replicas
                  name: Check deployment readiness where min != Max, Min >= 3 and Max > 3
                  type: aggregate
                  dependsOn:
                    - deployment-readiness-replicas-service-production
                    - deployment-readiness-replicas-service
                  method: or
        high-availability:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/8d83cfef-c2a7-4b8f-b154-274362342479
            name: high-availability-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/164a9d9b-cc07-4105-9a31-2bc46ae9c076
            facts:
                - id: app-toml-hpa-target-cpu
                  type: extract
                  source: github
                  jsonPath: .service.target_cpu_utilization_percentage // .service.production.target_cpu_utilization_percentage | . >= 20
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: app-toml-hpa-target-memory
                  type: extract
                  source: github
                  jsonPath: .service.target_memory_utilization_percentage // .service.production.target_memory_utilization_percentage | . >= 20
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: cpu-and-memory-hpa-are-set
                  name: Validate that CPU and Memory Horizontal Pod Autoscalers are set
                  type: aggregate
                  dependsOn:
                    - app-toml-hpa-target-cpu
                    - app-toml-hpa-target-memory
                  method: or
        instrumentation-check:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/6cb33f3a-60ea-466d-a3cc-c0402ebc83f8
            name: instrumentation-check-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/98aa724b-bd81-48f1-a002-1b443aa7906c
            facts:
                - id: read-otel-service-name-from-apptoml
                  name: Read OTEL_SERVICE_NAME from app.toml
                  type: extract
                  source: github
                  jsonPath: .envs.OTEL_SERVICE_NAME // .envs.production.OTEL_SERVICE_NAME // .service.production.envs.OTEL_SERVICE_NAME // .service.envs.OTEL_SERVICE_NAME
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: validate-otel-service-name-matches-component-name
                  name: validate OTEL_SERVICE_NAME matches component name
                  type: validate
                  dependsOn:
                    - read-otel-service-name-from-apptoml
                  rule: regex_match
                  pattern: ^quiz-api.*$
                - id: read-otel-resource-attributes-from-apptoml
                  name: Read OTEL_RESOURCE_ATTRIBUTES from app.toml
                  type: extract
                  source: github
                  jsonPath: .envs.OTEL_RESOURCE_ATTRIBUTES // .envs.production.OTEL_RESOURCE_ATTRIBUTES // .service.production.envs.OTEL_RESOURCE_ATTRIBUTES
                  repo: quiz-api
                  filePath: app.toml
                  rule: jsonpath
                - id: validate-otel-resource-attributes-sample-rate
                  name: validate OTEL_RESOURCE_ATTRIBUTES defines sample rate
                  type: validate
                  dependsOn:
                    - read-otel-resource-attributes-from-apptoml
                  rule: regex_match
                  pattern: of\.sample_rate=\d+.*
                - id: validate-otel-resource-attributes-one-sample-rate
                  name: validate OTEL_RESOURCE_ATTRIBUTES defines one sample rate
                  type: validate
                  dependsOn:
                    - read-otel-resource-attributes-from-apptoml
                  rule: regex_match
                  pattern: of\.error_sample_rate=\d+.*
                - id: either-sample-rate-or-error-sample-rate
                  name: Validate that OTEL_RESOURCE_ATTRIBUTES contains either of.sample_rate or of.error_sample_rate
                  type: aggregate
                  dependsOn:
                    - validate-otel-resource-attributes-sample-rate
                    - validate-otel-resource-attributes-error-sample-rate
                  method: or
                - id: either-sample-rate-or-error-sample-rate
                  name: Validate that both OTEL_SERVICE_NAME and OTEL_RESOURCE_ATTRIBUTES are set up correctly
                  type: aggregate
                  dependsOn:
                    - validate-otel-service-name-matches-component-name
                    - validate-otel-resource-attributes-one-sample-rate
                  method: and
        observability-documentation:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/2eb990cd-22a9-4ac2-90cc-bd0ffdc887ea
            name: observability-documentation-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/8808d2fd-9ea3-4ebb-9652-bfc3ddca7c4c
            facts:
                - id: extract-observability-md
                  name: Extract observability.md
                  type: extract
                  source: github
                  repo: quiz-api
                  filePath: docs/observability.md
                  rule: notempty
        organizational-standards:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/f56d74dd-234f-4ce6-b965-68dbbebddd07
            name: organizational-standards-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/f2c4711f-89c4-4a36-bebf-dd44336b2bc5
            facts:
                - id: readme-file
                  name: Check if the README.md file exists
                  type: extract
                  source: github
                  repo: quiz-api
                  filePath: README.md
                  rule: notempty
                - id: docs-readme-file
                  name: Check if the docs/README.md file exists
                  type: extract
                  source: github
                  repo: quiz-api
                  filePath: docs/README.md
                  rule: notempty
                - id: docs-index-file
                  name: Check if the docs/index.md file exists
                  type: extract
                  source: github
                  repo: quiz-api
                  filePath: docs/index.md
                  rule: notempty
                - id: paas-onboarded
                  name: Check if the service is using PaaS
                  type: extract
                  source: github
                  repo: quiz-api
                  searchString: motain/onefootball-actions/paas-deploy@master
                  rule: search
                - id: aggregate-readme-exists
                  name: Check if repo has documentation
                  type: aggregate
                  dependsOn:
                    - docs-index-file
                    - docs-readme-file
                    - readme-file
                  method: or
                - id: aggregate
                  name: Check if repo follows organizational standards
                  type: aggregate
                  dependsOn:
                    - aggregate-readme-exists
                    - paas-onboarded
                  method: and
        security-as-pipeline:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/4ff5501a-08b0-4a02-858e-6a7f76bbb61f
            name: security-as-pipeline-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/5476a4d0-3094-4c6e-9394-06ad83be748c
            facts:
                - id: trivy-exists-in-ci
                  name: Check if Trivy is used in CI/CD pipeline
                  type: extract
                  source: github
                  repo: quiz-api
                  searchString: motain/onefootball-actions/security
                  rule: search
        vulnerability-management:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/8d062bad-ec3e-4568-b8c1-efb8d8a515dd
            name: vulnerability-management-svc-quiz-api
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/ebde9d4a-2810-42ec-81c0-8aea8b9e6751
            facts:
                - id: service-vulnerabilities-prometheus
                  name: Get summary of vulnerabilities for services from Prometheus reports
                  type: extract
                  source: prometheus
                  prometheusQuery: sum(trivy_image_vulnerabilities{namespace="quiz-api", severity="Critical" })
    tribe: client-experience
    squad: sponsorship-integration
