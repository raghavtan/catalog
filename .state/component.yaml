apiVersion: of-catalog/v1alpha1
kind: Component
metadata:
    name: airship-email
    componentType: service
spec:
    id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:component/4d010f50-96c4-48c0-bab5-a3dd5112b464/08aeaa51-4663-4ddc-b227-8748b600737b
    name: airship-email
    slug: ""
    description: ""
    configVersion: 0
    typeId: SERVICE
    ownerId: ""
    dependsOn: []
    fields: {}
    links:
        - id: ""
          name: Repository
          type: REPOSITORY
          url: https://github.com/motain/airship-email
        - id: ""
          name: Monitoring page
          type: DASHBOARD
          url: https://grafana.mgm.onefootball.com/d/pthfJGV4z/kubernetes-app-metrics?orgId=1&refresh=30s&var-DS_PROMETHEUS=P0F161AC36DE6FE17&var-namespace=airship-email&var-container=airship-email&from=now-1h&to=now
        - id: ""
          name: OnCall
          type: ON_CALL
          url: https://onefootball.app.opsgenie.com/settings/schedule/detail/191b6b6d-f7eb-4a88-977e-bcc12f38b1b9
        - id: ""
          name: r-activation
          type: CHAT_CHANNEL
          url: https://onefootball.slack.com/archives/CK9LTN6DR
    documents: []
    labels:
        - fan-activation
        - airship-email
        - reach
    metricSources:
        alert-routing-and-notifications:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/9e2d2ba8-8e45-4ee3-8c3b-da1129344dbc
            name: alert-routing-and-notifications-svc-airship-email
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/075ae30c-3992-4de4-86b2-f33aff2bcb2a
            facts:
                - id: fetch-slos
                  name: Fetch SLOs
                  type: extract
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/slos/airship-email
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                - id: fetch-alerts-for-slos
                  name: Fetch alerts for SLOs
                  type: extract
                  dependsOn:
                    - fetch-slos
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/burn_alerts/airship-email?slo_id=:slo_id
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                - id: fetch-recipients-for-alerts
                  name: Fetch recipients for Alerts
                  type: extract
                  dependsOn:
                    - fetch-alerts-for-slos
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/burn_alerts/airship-email/:alert_id
                  jsonPath: .recipients[].target
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                - id: validate-each-target-is-not-empty-string
                  name: Validate that each target is not an empty string
                  type: validate
                  dependsOn:
                    - fetch-recipients-for-alerts
                  rule: regex_match
                  pattern: ^\S.*$
                - id: validate-all-targets-are-not-empty-strings
                  name: Validate that all targets are not empty strings
                  type: aggregate
                  dependsOn:
                    - validate-each-target-is-not-empty-string
        critical-alerts-slo-check:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/b9dd35bd-f178-413d-af32-a48386636878
            name: critical-alerts-slo-check-svc-airship-email
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/668e9c44-9839-4843-96cb-d0285c7eb13c
            facts:
                - id: fetch-slos
                  name: Fetch SLOs
                  type: extract
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/slos/airship-email
                  jsonPath: .[].id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                - id: fetch-alerts-for-slos
                  name: Fetch alerts for SLOs
                  type: extract
                  dependsOn:
                    - fetch-slos
                  source: jsonapi
                  uri: https://api.eu1.honeycomb.io/1/burn_alerts/airship-email?slo_id=:slo_id
                  jsonPath: .id
                  auth:
                    header: X-Honeycomb-Team
                    tokenVar: HONEYCOMB_API_KEY
                - id: count-slos
                  name: Count SLOs
                  type: aggregate
                  dependsOn:
                    - fetch-slos
                - id: count-alerts-for-slos
                  name: Count Alerts
                  type: aggregate
                  dependsOn:
                    - fetch-alerts-for-slos
                - id: validate-alerts-for-slos
                  name: Validate that counts match
                  type: validate
                  dependsOn:
                    - count-slos
                    - count-alerts-for-slos
                  rule: deps_match
        deployment-readiness:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/799082b8-cee0-467a-9a93-7765826e8fdf
            name: deployment-readiness-svc-airship-email
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/534fac90-3f8f-4fe5-acf1-dd0cde1c4d67
            facts:
                - id: deployment-readiness-replicas-service-production
                  name: Check deployment readiness where min != Max, Min >= 3 and Max > 3
                  type: extract
                  source: github
                  repo: airship-email
                  filePath: app.toml
                - id: deployment-readiness-replicas-service
                  name: Check deployment readiness where min != Max, Min >= 3 and Max > 3
                  type: extract
                  source: github
                  repo: airship-email
                  filePath: app.toml
                - id: aggregate-replicas
                  name: Check deployment readiness where min != Max, Min >= 3 and Max > 3
                  type: aggregate
                  dependsOn:
                    - deployment-readiness-replicas-service-production
                    - deployment-readiness-replicas-service
                  method: or
        instrumentation-check:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/e9a2f891-9fd3-4f11-ae4c-8b4761d3f12d
            name: instrumentation-check-svc-airship-email
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/7c84617b-b850-4b2c-a8d1-0d3cde1d28c1
            facts:
                - id: read-otel-service-name-from-apptoml
                  name: Read OTEL_SERVICE_NAME from app.toml
                  type: extract
                  source: github
                  jsonPath: .envs | if type == "array" then .[] | .id else .production[] | .OTEL_SERVICE_NAME end
                  repo: airship-email
                  filePath: app.toml
                - id: validate-otel-service-name-matches-component-name
                  name: validate OTEL_SERVICE_NAME matches component name
                  type: validate
                  dependsOn:
                    - read-otel-service-name-from-apptoml
                  rule: regex_match
                  pattern: ^airship-email$
                - id: read-otel-resource-attributes-from-apptoml
                  name: Read OTEL_RESOURCE_ATTRIBUTES from app.toml
                  type: extract
                  source: github
                  jsonPath: .envs | if type == "array" then .[] | .id else .production[] | .OTEL_RESOURCE_ATTRIBUTES end
                  repo: airship-email
                  filePath: app.toml
                - id: validate-otel-resource-attributes-sample-rate
                  name: validate OTEL_RESOURCE_ATTRIBUTES defines sample rate
                  type: validate
                  dependsOn:
                    - read-otel-resource-attributes-from-apptoml
                  rule: regex_match
                  pattern: of\.sample_rate=\d+.*
                - id: validate-otel-resource-attributes-one-sample-rate
                  name: validate OTEL_RESOURCE_ATTRIBUTES defines one sample rate
                  type: validate
                  dependsOn:
                    - read-otel-resource-attributes-from-apptoml
                  rule: regex_match
                  pattern: of\.error_sample_rate=\d+.*
                - id: either-sample-rate-or-error-sample-rate
                  name: Validate that OTEL_RESOURCE_ATTRIBUTES contains either of.sample_rate or of.error_sample_rate
                  type: aggregate
                  dependsOn:
                    - validate-otel-resource-attributes-sample-rate
                    - validate-otel-resource-attributes-error-sample-rate
                  rule: or
                - id: either-sample-rate-or-error-sample-rate
                  name: Validate that both OTEL_SERVICE_NAME and OTEL_RESOURCE_ATTRIBUTES are set up correctly
                  type: aggregate
                  dependsOn:
                    - validate-otel-service-name-matches-component-name
                    - validate-otel-resource-attributes-one-sample-rate
                  method: and
        observability-documentation:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/5844ad30-56fa-4321-bbda-2b5c06ff8f90
            name: observability-documentation-svc-airship-email
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/0ab028f7-40f9-4fbf-844c-4910a2e50b86
            facts:
                - id: extract-observability-md
                  name: Extract observability.md
                  type: extract
                  source: github
                  repo: airship-email
                  filePath: docs/observability.md
                - id: observability-md-is-not-empty
                  name: Validate that observability.md is not empty
                  type: validate
                  dependsOn:
                    - extract-observability-md
                  rule: regex_match
                  pattern: ^\S.*$
        organizational-standards:
            id: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-source/4d010f50-96c4-48c0-bab5-a3dd5112b464/9365e63f-6349-4793-a338-e73f647cf93c
            name: organizational-standards-svc-airship-email
            metric: ari:cloud:compass:fca6a80f-888b-4079-82e6-3c2f61c788e2:metric-definition/4d010f50-96c4-48c0-bab5-a3dd5112b464/1a256f6c-9392-4989-8dbb-aa0f5d27d21b
            facts:
                - id: readme-file
                  name: Check if the README.md file exists
                  type: extract
                  source: github
                  repo: airship-email
                  filePath: README.md
                - id: readme-file-exists
                  name: Validate that file README.md exists
                  type: validate
                  dependsOn:
                    - readme-file
                  rule: regex_match
                  pattern: ^\S.*$
                - id: docs-readme-file
                  name: Check if the docs/README.md file exists
                  type: extract
                  source: github
                  repo: airship-email
                  filePath: docs/README.md
                - id: docs-readme-file-exists
                  name: Validate that file README.md exists
                  type: validate
                  dependsOn:
                    - docs-readme-file
                  rule: regex_match
                  pattern: ^\S.*$
                - id: docs-index-file
                  name: Check if the docs/index.md file exists
                  type: extract
                  source: github
                  repo: airship-email
                  filePath: docs/index.md
                - id: docs-index-file-exists
                  name: Validate that file README.md exists
                  type: validate
                  dependsOn:
                    - docs-index-file
                  rule: regex_match
                  pattern: ^\S.*$
                - id: aggregate-readme-exists
                  name: Check if repo has documentation
                  type: aggregate
                  dependsOn:
                    - docs-index-file-exists
                    - docs-readme-file-exists
                    - readme-file-exists
                  method: or
    tribe: reach
    squad: fan-activation
